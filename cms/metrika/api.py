# -*- coding: utf-8 -*-
import urllib2
from urlparse import urlsplit, urljoin

from cms.conf import settings


def get_api(counter, resp_format='json'):
    return APICaller(api_url=settings.METRIKA_API_URL,
        id=counter.id, oauth_token=counter.token,
        resp_format=resp_format)


class APICallerError(BaseException): pass


class APICaller(object):
    def __init__(self, api_url, id, oauth_token, resp_format):
        self.auth_params = {'id': id, 'oauth_token': oauth_token}
        self.resp_format = resp_format

        url = urlsplit(api_url)
        if not url.scheme:
            url = urlsplit('http://' + api_url)
        self.api_url = url.geturl()

    def _action(self, method, action):
        def wrapper(**params):
            return self.action(method, action, **params)
        return wrapper

    def action(self, method, action, **params):
        # Check support request types
        if not method in ('get',):
            raise APICallerError(
                "APICaller don't support request method '%s'" % method
            )

        url = urljoin(self.api_url, action)
        return getattr(self, method)(url, **params)

    def get(self, url, **params):
        params.update(self.auth_params)
        query = '&'.join(['%s=%s' % (p, v) for p, v in params.iteritems()])
        request = urllib2.Request(
            '%s.%s?%s' % (url, self.resp_format, query)
        )
        return urllib2.urlopen(request)

    def __getattr__(self, request):
        method, action = request.split('_', 1)
        action = action.replace('_', '/')

        if not method and action:
            raise (AttributeError,
                   "APICaller instance has no attribute '%s'" % request)

        return self._action(method, action)


REGIONS = {
    u'Республика Адыгея': 'RU-AD',
    u'Республика Алтай': 'RU-AL',
    u'Республика Башкортостан': 'RU-BA',
    u'Республика Бурятия': 'RU-BU',
    u'Чеченская Республика': 'RU-CE',
    u'Чувашская Республика': 'RU-CU',
    u'Республика Дагестан': 'RU-DA',
    u'Республика Ингушетия': 'RU-IN',
    u'Республика Кабардино-Балкария': 'RU-KB',
    u'Республика Калмыкия': 'RU-KL',
    u'Карачаево-Черкесская Республика': 'RU-KC',
    u'Республика Карелия': 'RU-KR',
    u'Республика Хакасия': 'RU-KK',
    u'Республика Коми': 'RU-KO',
    u'Республика Марий Эл': 'RU-ME',
    u'Республика Мордовия': 'RU-MO',
    u'Республика Саха (Якутия)': 'RU-SA',
    u'Республика Северная Осетия-Алания': 'RU-SE',
    u'Республика Татарстан': 'RU-TA',
    u'Республика Тыва': 'RU-TY',
    u'Удмуртская Республика': 'RU-UD',
    u'Алтайский край': 'RU-ALT',
    u'Камчатский край': 'RU-KAM',
    u'Хабаровский край': 'RU-KHA',
    u'Краснодарский край': 'RU-KDA',
    u'Красноярский край': 'RU-KYA',
    u'Пермский край': 'RU-PER',
    u'Приморский край': 'RU-PRI',
    u'Ставропольский край': 'RU-STA',
    u'Забайкальский край': 'RU-ZAB',
    u'Амурская область': 'RU-AMU',
    u'Архангельская область': 'RU-ARK',
    u'Астраханская область': 'RU-AST',
    u'Белгородская область': 'RU-BEL',
    u'Брянская область': 'RU-BRY',
    u'Челябинская область': 'RU-CHE',
    u'Иркутская область': 'RU-IRK',
    u'Ивановская область': 'RU-IVA',
    u'Калининградская область': 'RU-KGD',
    u'Калужская область': 'RU-KLU',
    u'Кемеровская область': 'RU-KEM',
    u'Кировская область': 'RU-KIR',
    u'Костромская область': 'RU-KOS',
    u'Курганская область': 'RU-KGN',
    u'Курская область': 'RU-KRS',
    u'Санкт-Петербург и Ленинградская область': 'RU-LEN',
    u'Санкт-Петербург': 'RU-SPE',
    u'Липецкая область': 'RU-LIP',
    u'Магаданская область': 'RU-MAG',
    u'Москва и Московская область': 'RU-MOS',
    u'Москва': 'RU-MOW',
    u'Мурманская область': 'RU-MUR',
    u'Нижегородская область': 'RU-NIZ',
    u'Новгородская область': 'RU-NGR',
    u'Новосибирская область': 'RU-NVS',
    u'Омская область': 'RU-OMS',
    u'Оренбургская область': 'RU-ORE',
    u'Орловская область': 'RU-ORL',
    u'Пензенская область': 'RU-PNZ',
    u'Псковская область': 'RU-PSK',
    u'Ростовская область': 'RU-ROS',
    u'Рязанская область': 'RU-RYA',
    u'Сахалинская область': 'RU-SAK',
    u'Самарская область': 'RU-SAM',
    u'Саратовская область': 'RU-SAR',
    u'Смоленская область': 'RU-SMO',
    u'Свердловская область': 'RU-SVE',
    u'Тамбовская область': 'RU-TAM',
    u'Томская область': 'RU-TOM',
    u'Тульская область': 'RU-TUL',
    u'Тверская область': 'RU-TVE',
    u'Тюменская область': 'RU-TYU',
    u'Ульяновская область': 'RU-ULY',
    u'Владимирская область': 'RU-VLA',
    u'Волгоградская область': 'RU-VGG',
    u'Вологодская область': 'RU-VLG',
    u'Воронежская область': 'RU-VOR',
    u'Ярославская область': 'RU-YAR',
    u'Еврейская автономная область': 'RU-YEV',
    u'Чукотский автономный округ': 'RU-CHU',
    u'Ханты-Мансийский АО': 'RU-KHM',
    u'Ненецкий автономный округ': 'RU-NEN',
    u'Ямало-Ненецкий автономный округ': 'RU-YAN'
}


COUNTRIES = {
    u'Абхазия': 'AB',
    u'Австралия': 'AU',
    u'Австрия': 'AT',
    u'Азербайджан': 'AZ',
    u'Албания': 'AL',
    u'Алжир': 'DZ',
    u'Американское Самоа': 'AS',
    u'Ангилья': 'AI',
    u'Ангола': 'AO',
    u'Андорра': 'AD',
    u'Антарктида': 'AQ',
    u'Антигуа и Барбуда': 'AG',
    u'Аргентина': 'AR',
    u'Армения': 'AM',
    u'Аруба': 'AW',
    u'Афганистан': 'AF',
    u'Багамы': 'BS',
    u'Бангладеш': 'BD',
    u'Барбадос': 'BB',
    u'Бахрейн': 'BH',
    u'Беларусь': 'BY',
    u'Белиз': 'BZ',
    u'Бельгия': 'BE',
    u'Бенин': 'BJ',
    u'Бермуды': 'BM',
    u'Болгария': 'BG',
    u'Боливия, Многонациональное Государство': 'BO',
    u'Бонайре, Саба и Синт-Эстатиус': 'BQ',
    u'Босния и Герцеговина': 'BA',
    u'Ботсвана': 'BW',
    u'Бразилия': 'BR',
    u'Британская территория в Индийском океане': 'IO',
    u'Бруней-Даруссалам': 'BN',
    u'Буркина-Фасо': 'BF',
    u'Бурунди': 'BI',
    u'Бутан': 'BT',
    u'Вануату': 'VU',
    u'Венгрия': 'HU',
    u'Венесуэла Боливарианская Республика': 'VE',
    u'Британские Виргинские острова': 'VG',
    u'Виргинские острова': 'VI',
    u'Вьетнам': 'VN',
    u'Габон': 'GA',
    u'Гаити': 'HT',
    u'Гайана': 'GY',
    u'Гамбия': 'GM',
    u'Гана': 'GH',
    u'Гваделупа': 'GP',
    u'Гватемала': 'GT',
    u'Гвинея': 'GN',
    u'Гвинея-Бисау': 'GW',
    u'Германия': 'DE',
    u'Гернси': 'GG',
    u'Гибралтар': 'GI',
    u'Гондурас': 'HN',
    u'Гонконг': 'HK',
    u'Гренада': 'GD',
    u'Гренландия': 'GL',
    u'Греция': 'GR',
    u'Грузия': 'GE',
    u'Гуам': 'GU',
    u'Дания': 'DK',
    u'Джерси': 'JE',
    u'Джибути': 'DJ',
    u'Доминика': 'DM',
    u'Доминиканская Республика': 'DO',
    u'Египет': 'EG',
    u'Замбия': 'ZM',
    u'Западная Сахара': 'EH',
    u'Зимбабве': 'ZW',
    u'Израиль': 'IL',
    u'Индия': 'IN',
    u'Индонезия': 'ID',
    u'Иордания': 'JO',
    u'Ирак': 'IQ',
    u'Иран': 'IR',
    u'Ирландия': 'IE',
    u'Исландия': 'IS',
    u'Испания': 'ES',
    u'Италия': 'IT',
    u'Йемен': 'YE',
    u'Кабо-Верде': 'CV',
    u'Казахстан': 'KZ',
    u'Камбоджа': 'KH',
    u'Камерун': 'CM',
    u'Канада': 'CA',
    u'Катар': 'QA',
    u'Кения': 'KE',
    u'Кипр': 'CY',
    u'Киргизия': 'KG',
    u'Кирибати': 'KI',
    u'Китай': 'CN',
    u'Кокосовые острова': 'CC',
    u'Колумбия': 'CO',
    u'Коморы': 'KM',
    u'Конго': 'CG',
    u'Конго, Демократическая Республика': 'CD',
    u'Северная Корея': 'KP',
    u'Южная Корея': 'KR',
    u'Коста-Рика': 'CR',
    u'Кот д\'Ивуар': 'CI',
    u'Куба': 'CU',
    u'Кувейт': 'KW',
    u'Кюрасао': 'CW',
    u'Лаос': 'LA',
    u'Латвия': 'LV',
    u'Лесото': 'LS',
    u'Ливан': 'LB',
    u'Ливийская Арабская Джамахирия': 'LY',
    u'Либерия': 'LR',
    u'Лихтенштейн': 'LI',
    u'Литва': 'LT',
    u'Люксембург': 'LU',
    u'Маврикий': 'MU',
    u'Мавритания': 'MR',
    u'Мадагаскар': 'MG',
    u'Майотта': 'YT',
    u'Макао': 'MO',
    u'Малави': 'MW',
    u'Малайзия': 'MY',
    u'Мали': 'ML',
    u'Малые Тихоокеанские отдаленные острова Соединенных Штатов': 'UM',
    u'Мальдивы': 'MV',
    u'Мальта': 'MT',
    u'Марокко': 'MA',
    u'Мартиника': 'MQ',
    u'Маршалловы острова': 'MH',
    u'Мексика': 'MX',
    u'Микронезия, Федеративные Штаты': 'FM',
    u'Мозамбик': 'MZ',
    u'Молдова': 'MD',
    u'Монако': 'MC',
    u'Монголия': 'MN',
    u'Монтсеррат': 'MS',
    u'Мьянма': 'MM',
    u'Намибия': 'NA',
    u'Науру': 'NR',
    u'Непал': 'NP',
    u'Нигер': 'NE',
    u'Нигерия': 'NG',
    u'Нидерланды': 'NL',
    u'Никарагуа': 'NI',
    u'Ниуэ': 'NU',
    u'Новая Зеландия': 'NZ',
    u'Новая Каледония': 'NC',
    u'Норвегия': 'NO',
    u'Объединенные Арабские Эмираты': 'AE',
    u'Оман': 'OM',
    u'Остров Буве': 'BV',
    u'Остров Мэн': 'IM',
    u'Остров Норфолк': 'NF',
    u'Остров Рождества': 'CX',
    u'Остров Херд и острова Макдональд': 'HM',
    u'Острова Кайман': 'KY',
    u'Острова Кука': 'CK',
    u'Острова Теркс и Кайкос': 'TC',
    u'Пакистан': 'PK',
    u'Палау': 'PW',
    u'Палестинская территория, оккупированная': 'PS',
    u'Панама': 'PA',
    u'Папский Престол': 'VA',
    u'Папуа-Новая Гвинея': 'PG',
    u'Парагвай': 'PY',
    u'Перу': 'PE',
    u'Питкерн': 'PN',
    u'Польша': 'PL',
    u'Португалия': 'PT',
    u'Пуэрто-Рико': 'PR',
    u'Республика Македония': 'MK',
    u'Реюньон': 'RE',
    u'Россия': 'RU',
    u'Руанда': 'RW',
    u'Румыния': 'RO',
    u'Самоа': 'WS',
    u'Сан-Марино': 'SM',
    u'Сан-Томе и Принсипи': 'ST',
    u'Саудовская Аравия': 'SA',
    u'Свазиленд': 'SZ',
    u'Святая Елена, Остров вознесения, Тристан-да-Кунья': 'SH',
    u'Северные Марианские острова': 'MP',
    u'Сен-Бартельми': 'BL',
    u'Сен-Мартен': 'MF',
    u'Сенегал': 'SN',
    u'Сент-Винсент и Гренадины': 'VC',
    u'Сент-Китс и Невис': 'KN',
    u'Сент-Люсия': 'LC',
    u'Сент-Пьер и Микелон': 'PM',
    u'Сербия': 'RS',
    u'Сейшелы': 'SC',
    u'Сингапур': 'SG',
    u'Синт-Мартен': 'SX',
    u'Сирийская Арабская Республика': 'SY',
    u'Словакия': 'SK',
    u'Словения': 'SI',
    u'Великобритания': 'GB',
    u'США': 'US',
    u'Соломоновы острова': 'SB',
    u'Сомали': 'SO',
    u'Судан': 'SD',
    u'Суринам': 'SR',
    u'Сьерра-Леоне': 'SL',
    u'Таджикистан': 'TJ',
    u'Таиланд': 'TH',
    u'Тайвань (Китай)': 'TW',
    u'Танзания, Объединенная Республика': 'TZ',
    u'Тимор-Лесте': 'TL',
    u'Того': 'TG',
    u'Токелау': 'TK',
    u'Тонга': 'TO',
    u'Тринидад и Тобаго': 'TT',
    u'Тувалу': 'TV',
    u'Тунис': 'TN',
    u'Туркмения': 'TM',
    u'Турция': 'TR',
    u'Уганда': 'UG',
    u'Узбекистан': 'UZ',
    u'Украина': 'UA',
    u'Уоллис и Футуна': 'WF',
    u'Уругвай': 'UY',
    u'Фарерские острова': 'FO',
    u'Фиджи': 'FJ',
    u'Филиппины': 'PH',
    u'Финляндия': 'FI',
    u'Фолклендские острова': 'FK',
    u'Франция': 'FR',
    u'Французская Гвиана': 'GF',
    u'Французская Полинезия': 'PF',
    u'Французские Южные территории	  ': 'TF',
    u'Хорватия': 'HR',
    u'Центрально-Африканская Республика': 'CF',
    u'Чад': 'TD',
    u'Черногория': 'ME',
    u'Чехия': 'CZ',
    u'Чили': 'CL',
    u'Швейцария': 'CH',
    u'Швеция': 'SE',
    u'Шпицберген и Ян Майен': 'SJ',
    u'Шри-Ланка': 'LK',
    u'Эквадор': 'EC',
    u'Экваториальная Гвинея': 'GQ',
    u'Эландские острова': 'AX',
    u'Эль-Сальвадор': 'SV',
    u'Эритрея': 'ER',
    u'Эстония': 'EE',
    u'Эфиопия': 'ET',
    u'ЮАР': 'ZA',
    u'Южная Джорджия и Южные Сандвичевы острова': 'GS',
    u'Южная Осетия': 'OS',
    u'Южный Судан': 'SS',
    u'Ямайка': 'JM',
    u'Япония': 'JP'
}
